<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secret Santa Quest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(45deg, #ff0000, #00ff00);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    #game-box {
      width: 90%;
      max-width: 700px;
      background: #800000;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
      border: 2px solid #00ff00;
    }
    #text { min-height: 120px; }
    button {
      margin: 6px 6px 0 0;
      padding: 10px 14px;
      background: #008000;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button:hover { background: #00cc00; }
    input[type=text] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #00ff00;
      width: 80%;
      box-sizing: border-box;
      margin-top: 8px;
      background: #800000;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="game-box">
    <div id="text">Welcome to your Secret Santa Quest! Click below to begin.</div>
    <div id="choices"></div>
    <div style="margin-top:12px;"><button id="startBtn">Begin</button></div>
  </div>

  <script>
  (function(){
    let gameState = { scene:'start', x:2, y:2, gridSize:7, puzzlesSolved:{}, inventory:[] };
    const textEl = document.getElementById('text');
    const choicesEl = document.getElementById('choices');
    const startBtn = document.getElementById('startBtn');

    function coordKey(x,y){ return `${x},${y}`; }
    function isPuzzleAt(x,y){ const puzzles=[{x:1,y:1},{x:4,y:1},{x:5,y:3},{x:2,y:5},{x:5,y:5}]; return puzzles.some(p=>p.x===x && p.y===y); }

    function setScene(text,choices){
      textEl.innerHTML = text;
      choicesEl.innerHTML = '';
      (choices||[]).forEach(c=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.innerText=c.label;
        btn.onclick=c.action;
        choicesEl.appendChild(btn);
      });
    }

    function movementButtons(){
      return [
        { label:'â¬†ï¸', action:()=>move(0,-1) },
        { label:'â¬‡ï¸', action:()=>move(0,1) },
        { label:'â¬…ï¸', action:()=>move(-1,0) },
        { label:'âž¡ï¸', action:()=>move(1,0) },
        { label:'Map', action:showMap },
        { label:'Inventory', action:showInventory }
      ];
    }

    function startGame(){ gameState.scene='world'; renderScene(); }

    function renderScene(){
      const tile = describeTile(gameState.x, gameState.y);
      setScene(tile.text, tile.actions);
    }

    function showMap(){
      let map='';
      for(let y=0;y<gameState.gridSize;y++){
        for(let x=0;x<gameState.gridSize;x++){
          if(x===gameState.x && y===gameState.y) map+='ðŸ”´';
          else if(isPuzzleAt(x,y) && gameState.puzzlesSolved[coordKey(x,y)]) map+='âœ…';
          else if(isPuzzleAt(x,y)) map+='â“';
          else map+='Â·';
          map+=' ';
        }
        map+='<br/>';
      }
      setScene('<strong>Minimap</strong><br/>'+map,[{label:'Return',action:renderScene}]);
    }

    function move(dx,dy){
      const nx=gameState.x+dx, ny=gameState.y+dy;
      if(nx<0||ny<0||nx>=gameState.gridSize||ny>=gameState.gridSize){ setScene("You can't walk that way.",movementButtons()); return; }
      gameState.x=nx; gameState.y=ny; renderScene();
    }

    function showInventory(){
      setScene(`<strong>Inventory:</strong><br/>${gameState.inventory.length?gameState.inventory.join(', '):'Empty'}`,[{label:'Return',action:renderScene}]);
    }

    function inputPuzzle(key, correct, pid, loose=false){
      const inputId = 'puzzleInput_'+key;
      const html = `Enter your answer:<br/><input id="${inputId}" type="text" />`;
      setScene(html,[{
        label:'Submit',
        action:()=>{
          const el = document.getElementById(inputId); if(!el) return;
          let answer = el.value||''; if(loose) answer=answer.toLowerCase().trim();
          const ok = (answer===correct)||(answer.toLowerCase().trim()===correct.toLowerCase());
          if(ok){
            gameState.puzzlesSolved[key] = true;
            if(pid==='p4' && !gameState.inventory.includes('Brass Key')) gameState.inventory.push('Brass Key');
            setScene('âœ… Correct! Puzzle solved.', [{label:'Continue', action: renderScene}]);
          } else {
            setScene('âŒ Incorrect. Try again.', [{label:'Return', action:()=>inputPuzzle(key,correct,pid,loose)}]);
          }
        }
      }]);
    }

    function describeTile(x,y){
      const key = coordKey(x,y);
      if(x===1 && y===1 && !gameState.puzzlesSolved[key]) return { text:"A humming runestone asks: 'What comes next? 8,16,32...'", actions:[{label:'Answer', action:()=>inputPuzzle(key,'64','p1')}, ...movementButtons()] };
      if(x===4 && y===1 && !gameState.puzzlesSolved[key]) return { text:"Decode ROT13 word: Cvb (ROT13 means shift letters by 13, ex: A->N)", actions:[{label:'Decode', action:()=>inputPuzzle(key,'Poi','p2')}, ...movementButtons()] };
      if(x===5 && y===3 && !gameState.puzzlesSolved[key]) return { text:"2,3,5,7,11... Next prime?", actions:[{label:'Answer', action:()=>inputPuzzle(key,'13','p3')}, ...movementButtons()] };
      if(x===2 && y===5 && !gameState.puzzlesSolved[key]) return { text:"A mysterious lock panel has letters with clues: Five people were eating apples, A finished before B, but behind C. D finished before E, but behind B. Enter the letters in order on the lock.", actions:[{label:'Enter Letters', action:()=>inputPuzzle(key,'CABDE','p4',true)}, ...movementButtons()] };
      if(x===5 && y===5 && !gameState.puzzlesSolved[key]) return { text:"Memory sprite: Colors red, green, brown, green, yellow. Type in reverse.", actions:[{label:'Enter Pattern', action:()=>inputPuzzle(key,'yellow green brown green red','p5',true)}, ...movementButtons()] };
      const allSolved=['p1','p2','p3','p4','p5'].every(p=>gameState.puzzlesSolved[coordKeyForPid(p)]);
      const hasKey=gameState.inventory.includes('Brass Key');
      if(x===6 && y===6){
        if(allSolved && hasKey) return { text:"A final chest opens! Your gift is at the back of the Page-McCaw kitchen shelf.", actions:[] };
        let msg="A sealed vault. Missing:"; if(!allSolved) msg+=" Complete puzzles."; if(!hasKey) msg+=" Brass Key needed.";
        return { text:msg, actions:movementButtons() };
      }
      return { text:`You walk through a festive forest. Position: (${x},${y})`, actions:movementButtons() };
    }

    function coordKeyForPid(pid){
      const mapping = { 'p1':'1,1','p2':'4,1','p3':'5,3','p4':'2,5','p5':'5,5' };
      return mapping[pid];
    }

    startBtn.addEventListener('click',startGame);
    renderScene();
  })();
  </script>
</body>
</html>
